---
title: "cap"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{cap}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
## Currently set to eval=FALSE

knitr::opts_chunk$set(
  collapse = TRUE, eval=FALSE,
  comment = "#>"
)
```

```{r setup}
library(retroharmonize)
cap_files <- c('ZA4529_v3-0-1.sav', 'ZA5688_v6-0-0.sav', 'ZA6925_v1-0-0.sav')
```

To replicate this example, you must acquire these files from [GESIS]() after accepting their terms of use.  The `retroharmonize` project is not affiliated with GESIS.

```{r, eval=FALSE}
## This is a dummy path. You should use the path where you saved these files.
gesis_dir <- file.path("C:", "your_data", "gesis_files")
```

```{r, eval=FALSE}
## Create full paths to the three selected files
cap_files <- file.path(gesis_dir, cap_files)
```

## Inventory

```{r, eval=FALSE}
document_cap_files <- document_surveys(survey_path = cap_files, .f = "read_spss")
```
```{r printdocument, eval=FALSE}
knitr::kable(document_cap_files)
```

The files are rather large. We have `sum(document_cap_files$nrow)` of `sum(document_cap_files$ncol)` variables.  We will only harmonize a few of them.

## Importing 

It is likely that the surveys will fit into your computer's memory, so you can omit the first step. If you work with many files, and you want to keep working sequentially with survey files, it is a good idea to convert them to R objects.  



## Concepts to harmonize

```{r metadatasurveys, eval=FALSE}
cap_metadata <- metadata_create(survey_files = cap_files)
```


### Weights

```{r, eval=FALSE}
weight_variables <- eb_metadata %>% 
  filter ( .data$var_name_orig %in% c("isocntry", "wex", "wextra", "v47", "v7"))
```

```{r, eval=FALSE}
weigthing_crosswalk_table <- crosswalk_table_create(weight_variables) %>%
  select ( -all_of(c("val_numeric_orig", "val_numeric_target", "val_label_orig", "val_label_target"))) %>%
  mutate ( var_name_target = ifelse (
    .data$var_name_target %in% c("wex", "wextra", "v47"), 
    yes = "wex", no = "geo"), 
    class_target = ifelse(.data$var_name_target %in% c("geo", "v47"), "factor", "numeric"))
```

The crosswalk table contains the original (source) variable names that must be converted to the target variable names, i.e. `v7` and `isocntry` to `geo` and `v47`, `wextra`, and `wex` to `wex`.

```{r, eval=FALSE}
weigthing_crosswalk_table %>% 
  select ( all_of(c("filename", "var_name_orig", "var_name_target")))
```


```{r, eval=FALSE}
variables_of_interest <- cap_metadata %>%
  filter ( .data$var_name_orig %in% c("rowid|isocntry") | 
             grepl(search_term_labels, .data$var_label_orig) |
             .data$var_name_orig %in% c("w1", "wex", "w3", "w3a", "w4", "w4a")) 

variables_of_interest
```


